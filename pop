#!/bin/bash
#
# pop - Project Operation
#
# A simple project operation execution script for environments lacking "make",
# "just", "pip", "uv", and "poetry" and where installing Python dependencies at
# the system level is undesirable. This script manages a local virtualenv and
# provides common project operations.
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
PYTHON="${VENV_DIR}/bin/python"
PROG="$SCRIPT_DIR/serialtest.py"

# Exit codes
EXIT_OK=0
EXIT_USAGE=2          # Missing argument or invalid operation
EXIT_SETUP_FAILED=4   # Setup or dependency installation failed
EXIT_RUN_FAILED=5     # Python script or test execution failed

usage() {
    cat <<EOF
Usage: $(basename "$0") <operation> [args...]

Operations:
  setup              Create virtualenv and install dependencies
  clean              Remove cache directories (__pycache__, .pytest_cache, etc.)
  distclean          Remove virtualenv and all cache directories
  test               Run all tests (unit + integration)
  test-unit          Run unit tests only (fast, no socat required)
  test-integration   Run integration tests only (requires Linux + socat)
  run [args]         Run serial test (args passed to serialtest.py)
  help               Show this help message

Examples:
  ./pop run -d /dev/ttyAMA4 -r server          # Run as server
  ./pop run -d /dev/ttyUSB0 -r client -n 100   # Run as client with msg count

Run './pop run --help' for run options (device, role, baudrate, etc.)
EOF
}

cmd_setup() {
    echo "Creating virtualenv in $VENV_DIR..."
    if ! python3 -m venv "$VENV_DIR"; then
        echo "Error: Failed to create virtualenv." >&2
        exit $EXIT_SETUP_FAILED
    fi
    echo "Installing dependencies..."
    if ! "$VENV_DIR/bin/pip" install --quiet --upgrade pip; then
        echo "Error: Failed to upgrade pip." >&2
        exit $EXIT_SETUP_FAILED
    fi
    if ! "$VENV_DIR/bin/pip" install --quiet -r "$SCRIPT_DIR/requirements.txt"; then
        echo "Error: Failed to install requirements." >&2
        exit $EXIT_SETUP_FAILED
    fi
    echo "Setup complete."
}

ensure_setup() {
    if [[ ! -x "$PYTHON" ]]; then
        echo "Virtualenv not found. Running setup..."
        cmd_setup
    fi
}

cmd_clean() {
    echo "Removing cache directories..."
    rm -rf "$SCRIPT_DIR"/__pycache__
    rm -rf "$SCRIPT_DIR"/*/__pycache__
    rm -rf "$SCRIPT_DIR"/.mypy_cache
    rm -rf "$SCRIPT_DIR"/.pytest_cache
    rm -rf "$SCRIPT_DIR"/.ruff_cache
    echo "Cache clean complete."
}

cmd_distclean() {
    cmd_clean
    echo "Removing virtualenv..."
    rm -rf "$VENV_DIR"
    echo "Distclean complete."
}

cmd_test() {
    ensure_setup
    echo "Running tests..."
    # Run all tests with pytest; integration tests requiring Linux will be
    # automatically skipped on non-Linux platforms via @pytest.mark.skipif
    if ! "$PYTHON" -m pytest "$SCRIPT_DIR/test" -v; then
        echo "Error: Tests failed." >&2
        exit $EXIT_RUN_FAILED
    fi
}

cmd_test_unit() {
    ensure_setup
    echo "Running unit tests..."
    if ! "$PYTHON" -m pytest "$SCRIPT_DIR/test" -m unit -v; then
        echo "Error: Unit tests failed." >&2
        exit $EXIT_RUN_FAILED
    fi
}

cmd_test_integration() {
    ensure_setup
    echo "Running integration tests..."
    if ! "$PYTHON" -m pytest "$SCRIPT_DIR/test" -m integration -v; then
        echo "Error: Integration tests failed." >&2
        exit $EXIT_RUN_FAILED
    fi
}

cmd_run() {
    ensure_setup
    if ! "$PYTHON" "$PROG" "$@"; then
        echo "Error: Run failed." >&2
        exit $EXIT_RUN_FAILED
    fi
}

if [[ $# -lt 1 ]]; then
    usage
    exit $EXIT_USAGE
fi

case "$1" in
    setup)
        cmd_setup
        ;;
    clean)
        cmd_clean
        ;;
    distclean)
        cmd_distclean
        ;;
    test)
        cmd_test
        ;;
    test-unit)
        cmd_test_unit
        ;;
    test-integration)
        cmd_test_integration
        ;;
    run)
        shift
        cmd_run "$@"
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Error: Unknown operation '$1'" >&2
        usage
        exit $EXIT_USAGE
        ;;
esac
